/* Scratchcard - A scratch card library based on canvas
 * @author kikoshoung (kikoshoung@gmail.com)
 * last modified at 2014-01-23 11:25:25
 */
(function(){function t(t){this.options=t,this.scratchActivated=!1,this.extendOptions(),this.initialize()}function e(t){if("object"!=typeof t||null==t||t.nodeType)return t;var e=t.constructor===Array?[]:{};for(var n in t)e[n]=arguments.callee(t[n]);return e}function n(t,n){var o=e(n);t=t||{},n=n||{};for(var i in t)o[i]=t[i]instanceof Object&&!t[i].nodeType?t[i]instanceof Array||t[i]instanceof Function?e(t[i]):arguments.callee(t[i],o[i]):t[i];return o}function o(t){for(var e=[t.offsetLeft,t.offsetTop],n=t.offsetParent;n;)e[0]+=n.offsetLeft,e[1]+=n.offsetTop,n=n.offsetParent;return e}function i(t,e,n){document.addEventListener?t.addEventListener(e,n,!1):document.attachEvent?t.attachEvent("on"+e,n):t["on"+e]=n}function s(t,e,n){document.removeEventListener?t.removeEventListener(e,n,!1):document.detachEvent?t.detachEvent("on"+e,n):t["on"+e]=null}function r(t,e){return function(){t.apply(e,arguments)}}var a="ontouchstart"in window?!1:!0;t.prototype={defaults:{container:null,imgSrc:"",size:[240,180],percentage:.6,scratchLayer:{background:"#E0E0E0",text:"\u522e\u5f00\u6b64\u6d82\u5c42",color:"#888",font:"30px Verdana",lineWidth:30},notSupportText:"Sorry, [Canvas] is not supported.",onScratch:null,onComplete:null},events:{mousedown:a?"mousedown":"touchstart",mousemove:a?"mousemove":"touchmove",mouseup:a?"mouseup":"touchend"},extendOptions:function(){this.options=n(this.options,this.defaults)},initialize:function(){var t=this.options,e=this;this.isOptionsAvailable(t)&&this.setImage(t,function(){e.setContainer(t),e.setCanvas(t),e.initCanvas(),e.bindEvents()})},isOptionsAvailable:function(t){var e=t.container,n=t.imgSrc,o=t.size,i=t.validArea,s=t.percentage;if(!e||!e.nodeType||1!=e.nodeType)throw Error("Param [container] must be given and must be a original dom element.");if(!n||"string"!=typeof n)throw Error("Param [imgSrc] must be given and must be a string.");if(o&&!(o instanceof Array))throw Error("Param [size] must be an array like [{width}, {height}].");if(i&&!(i instanceof Array))throw Error("Param [validArea] must be an array like [{left}, {top}, {width}, {height}].");if(s&&"number"!=typeof s&&"string"!=typeof s)throw Error('Param [percentage] must be a number or string like 0.8 or "0.8".');return!0},setContainer:function(t){var e=t.container,n=(this.curSize,e.style.cssText+"display: inline-block; position: relative; background: transparent;");e.innerHTML="",e.style.cssText=n,e.style.width=this.curSize[0]+"px",e.style.height=this.curSize[1]+"px",this.container=e},setImage:function(t,e){var n=new Image,o=this,i="position: relative; z-index: 1; vertical-align: middle;";n.onload=function(){var s=o.getCurSize(t);o.origSize=[n.width,n.height],o.curSize=s,n.width=s[0],n.height=s[1],e&&e(),n.style.cssText=i,t.container.appendChild(n)},n.src=t.imgSrc,this.img=n},setCanvas:function(t){var e=t.container,n=document.createElement("canvas"),o="position: absolute; z-index: 2; top: 0; left: 0;";n.innerHTML=t.notSupportText,n.style.cssText=o,n.width=n.style.width=this.curSize[0],n.height=n.style.height=this.curSize[1],e.appendChild(n),this.canvas=n},setCanvasToErrorMode:function(){var t=this.defaults.scratchLayer;this.canvas.style.background=t.background,this.canvas.style.color=t.color},getCurSize:function(t){var e=t.size,n=t.origSize;return(e||n).slice()},getScratchedPercentage:function(){for(var t=this.ctx,e=this.canvas,n=this.options,o=n.validArea||[0,0,e.width,e.height],i=t.getImageData.apply(t,o).data,s=0,r=0,a=i.length;a>r;r+=4)0==i[r+3]&&s++;return s/(a/4)},getCoordinate:function(t){var e,n;return t.targetTouches&&(t=t.targetTouches[0]),e=t.pageX,n=t.pageY,void 0===e&&(e=t.clientX+(document.body.scrollLeft||document.documentElement.scrollLeft)),void 0===n&&(n=t.clientY+(document.body.scrollTop||document.documentElement.scrollTop)),[e,n]},initCanvas:function(){var t,e=this.canvas,n=this.options,o=n.scratchLayer;try{t=this.ctx=e.getContext("2d")}catch(i){throw this.setCanvasToErrorMode(),Error(n.notSupportText)}t.globalCompositeOperation="source-over",t.fillStyle=o.background,t.fillRect(0,0,e.width,e.height),t.font=o.font,t.textBaseline="middle",t.textAlign="center",t.fillStyle=o.color,t.fillText(o.text,e.width/2,e.height/2),t.strokeStyle="rgba(255, 255, 255, 1)",t.lineJoin="round",t.lineCap="round",t.lineWidth=o.lineWidth},bindEvents:function(){var t=this.canvas,e=this.container,n=this.events,o=this.onmousedown=r(this.mousedownHandler,this),s=this.onmousemove=r(this.mousemoveHandler,this),a=this.onmouseup=r(this.mouseupHandler,this),c=this.onmouseout=r(this.mouseoutHandler,this),u=this.onmousemoveContainer=r(this.mousemoveContainerHandler,this);i(t,n.mousedown,o),i(t,n.mousemove,s),i(t,n.mouseup,a),i(t,"mouseout",c),i(e,n.mousemove,u)},mousedownHandler:function(t){var e=this.ctx,n=this.canvas,i=this.canvasOffset||(this.canvasOffset=o(n)),s=this.getCoordinate(t);this.scratchActivated=!0,e.beginPath(),e.moveTo(s[0]-i[0],s[1]-i[1])},mousemoveHandler:function(t){if(this.scratchActivated){var e=this.ctx,n=this.canvas,o=this.canvasOffset,i=this.getCoordinate(t);e.lineTo(i[0]-o[0],i[1]-o[1]),e.globalCompositeOperation="destination-out",e.stroke(),n.style.opacity=n.style.opacity?"":"0.999"}},mouseupHandler:function(){var t=this.ctx,e=this.options.onScratch;this.scratchActivated=!1,t.closePath(),e&&e(this.getScratchedPercentage()),this.isOktoShowAll(this.getScratchedPercentage())},mouseoutHandler:function(){this.scratchActivated=!1},mousemoveContainerHandler:function(t){t.preventDefault()},isOktoShowAll:function(t){var e=this.options,n=e.onComplete;t>=e.percentage&&(this.showAll(),n&&n())},showAll:function(){this.canvas.style.display="none"},destroy:function(){var t=this.container,e=this.canvas,n=this.img;s(e,events.mousedown,this.onmousedown),s(e,events.mousemove,this.onmousemove),s(e,events.mouseup,this.onmouseup),s(e,"mouseout",this.onmouseout),s(t,events.mousemove,this.onmousemoveContainer),n.onload=null,t.removeChild(e),t.removeChild(n)}},window.ScratchCard=t,window.jQuery&&($.fn.ScratchCard=function(e){return e.container=$(this)[0],new t(e)})})();